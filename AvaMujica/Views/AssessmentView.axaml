<UserControl
    x:Class="AvaMujica.Views.AssessmentView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:AvaMujica.ViewModels"
    d:DesignHeight="900"
    d:DesignWidth="400"
    x:DataType="vm:AssessmentViewModel"
    mc:Ignorable="d">
    <Design.DataContext>
        <vm:AssessmentViewModel />
    </Design.DataContext>

    <Grid Margin="16" RowDefinitions="Auto,*,Auto">
        <!--  顶部选择量表  -->
        <Border
            Padding="12"
            Background="{DynamicResource SystemChromeMediumLowColor}"
            BorderBrush="{DynamicResource SystemBaseLowColor}"
            BorderThickness="1"
            CornerRadius="10">
            <!--  使用 WrapPanel：宽度不足时描述文本自动换到下一行  -->
            <WrapPanel x:Name="HeaderWrapPanel" Orientation="Horizontal">
                <ComboBox
                    Width="280"
                    Margin="0,0,8,0"
                    DisplayMemberBinding="{Binding Name}"
                    ItemsSource="{Binding Scales}"
                    SelectedItem="{Binding SelectedScale}" />
                <TextBlock
                    MaxWidth="{Binding #HeaderWrapPanel.Bounds.Width}"
                    Margin="0,4,0,0"
                    VerticalAlignment="Center"
                    Text="{Binding SelectedScale.Description}"
                    TextWrapping="Wrap" />
            </WrapPanel>
        </Border>

        <!--  问卷主体  -->
        <Border
            Grid.Row="1"
            Padding="20"
            Background="{DynamicResource SystemChromeLowColor}"
            BorderBrush="{DynamicResource SystemBaseLowColor}"
            BorderThickness="1"
            CornerRadius="12">
            <Grid>
                <!--  正在答题  -->
                <Grid IsVisible="{Binding !IsCompleted}" RowDefinitions="Auto,*,Auto">
                    <!--  顶部：页码 + 进度 + 题干  -->
                    <StackPanel Grid.Row="0" Spacing="12">
                        <StackPanel
                            VerticalAlignment="Center"
                            Orientation="Horizontal"
                            Spacing="8">
                            <TextBlock FontSize="16" Text="题目" />
                            <TextBlock FontSize="16" Text="{Binding CurrentPage}" />
                            <TextBlock FontSize="16" Text="/" />
                            <TextBlock FontSize="16" Text="{Binding TotalQuestions}" />
                        </StackPanel>
                        <ProgressBar
                            Height="6"
                            CornerRadius="3"
                            Maximum="{Binding TotalQuestions}"
                            Minimum="0"
                            Value="{Binding CurrentPage}" />
                        <Border
                            Padding="12"
                            Background="{DynamicResource SystemControlAcrylicWindowBrush}"
                            CornerRadius="8">
                            <TextBlock
                                FontSize="20"
                                FontWeight="SemiBold"
                                Text="{Binding CurrentQuestion.Text}"
                                TextWrapping="Wrap" />
                        </Border>
                    </StackPanel>

                    <!--  中间：选项列表（占据剩余空间，内部滚动）  -->
                    <Border
                        Grid.Row="1"
                        Margin="0,8,0,8"
                        Padding="8"
                        Background="{DynamicResource SystemChromeMediumLowColor}"
                        BorderBrush="{DynamicResource SystemBaseLowColor}"
                        BorderThickness="1"
                        CornerRadius="8">
                        <ListBox
                            ItemsSource="{Binding CurrentQuestion.Options}"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            SelectedIndex="{Binding SelectedOptionIndex, Mode=TwoWay}">
                            <ListBox.Styles>
                                <Style Selector="ListBoxItem">
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0,6" />
                                    <Setter Property="CornerRadius" Value="6" />
                                </Style>
                                <!--  可选：如需去掉容器自带的悬浮底色，取消注释下面两条  -->
                                <Style Selector="ListBoxItem:pointerover">
                                    <Setter Property="Background" Value="Transparent" />
                                </Style>
                                <Style Selector="ListBoxItem:selected">
                                    <Setter Property="Background" Value="Transparent" />
                                </Style>

                                <!--  提升选中/悬停的可见度：直接作用于模板内容里的 Border/TextBlock  -->
                                <Style Selector="ListBoxItem:pointerover Border">
                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColorLight2}" />
                                </Style>
                                <Style Selector="ListBoxItem:selected Border">
                                    <Setter Property="Background" Value="{DynamicResource SystemAccentColorLight3}" />
                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}" />
                                    <Setter Property="BorderThickness" Value="2" />
                                </Style>
                                <Style Selector="ListBoxItem:selected TextBlock">
                                    <Setter Property="FontWeight" Value="SemiBold" />
                                    <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}" />
                                </Style>
                            </ListBox.Styles>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Margin="0"
                                        Padding="10"
                                        Background="{DynamicResource SystemChromeLowColor}"
                                        BorderBrush="{DynamicResource SystemBaseLowColor}"
                                        BorderThickness="1"
                                        CornerRadius="6">
                                        <TextBlock Text="{Binding Text}" TextWrapping="Wrap" />
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>

                    <!--  底部：操作按钮  -->
                    <Grid
                        Grid.Row="2"
                        Margin="0,4,0,0"
                        ColumnDefinitions="*,*">
                        <Button
                            Grid.Column="0"
                            Margin="0,0,8,0"
                            HorizontalAlignment="Center"
                            Command="{Binding PrevCommand}"
                            Content="上一题" />
                        <Button
                            Grid.Column="1"
                            Margin="0,0,8,0"
                            HorizontalAlignment="Center"
                            Command="{Binding NextCommand}"
                            Content="下一题"
                            IsVisible="{Binding !IsLastQuestion}" />
                        <Button
                            Grid.Column="1"
                            HorizontalAlignment="Center"
                            Command="{Binding SubmitCommand}"
                            Content="提交"
                            IsVisible="{Binding IsLastQuestion}" />
                    </Grid>
                </Grid>

                <!--  完成后显示结果  -->
                <Grid IsVisible="{Binding IsCompleted}" RowDefinitions="Auto,*">
                    <StackPanel Grid.Row="0" Spacing="12">
                        <TextBlock
                            FontSize="20"
                            FontWeight="Bold"
                            Text="评估结果" />
                        <TextBlock Text="{Binding Result.ScaleName}" />
                        <TextBlock Text="{Binding Result.TotalScore, StringFormat=总分：{0}}" />
                        <TextBlock Text="{Binding Result.Level, StringFormat=等级：{0}}" />
                        <TextBlock Text="{Binding Result.Advice, StringFormat=建议：{0}}" TextWrapping="Wrap" />

                        <StackPanel
                            Margin="0,8,0,0"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button Command="{Binding RestartCommand}" Content="重新开始" />
                            <Button Command="{Binding ExplainByAiCommand}" Content="AI 解释结果" />
                            <ProgressBar
                                Width="120"
                                IsIndeterminate="True"
                                IsVisible="{Binding IsExplaining}" />
                        </StackPanel>
                    </StackPanel>

                    <Border
                        Grid.Row="1"
                        Padding="8"
                        BorderBrush="{DynamicResource SystemBaseLowColor}"
                        BorderThickness="1"
                        CornerRadius="6"
                        IsVisible="{Binding HasAiExplanation}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <TextBox
                                IsReadOnly="True"
                                Text="{Binding AiExplanation}"
                                TextWrapping="Wrap" />
                        </ScrollViewer>
                    </Border>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
